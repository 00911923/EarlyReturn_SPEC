# Record + @AssertTrue æ¸¬è©¦æŒ‡å—

## ğŸ¯ æ¸¬è©¦ç›®æ¨™

æ¸¬è©¦ `UserVipRequest` Record å¦‚ä½•ä½¿ç”¨ `@AssertTrue` é€²è¡Œè¤‡é›œçš„æ¥­å‹™é‚è¼¯é©—è­‰ã€‚

---

## ğŸš€ æº–å‚™å·¥ä½œ

### 1. ç¢ºèªæ‡‰ç”¨ç¨‹å¼æ­£åœ¨é‹è¡Œ

æª¢æŸ¥ IntelliJ Console æ˜¯å¦æœ‰ä»¥ä¸‹è¨Šæ¯ï¼š
```
Started ValidationDemoApplication in X.X seconds
```

å¦‚æœæ²’æœ‰ï¼Œè«‹é‡æ–°å•Ÿå‹•æ‡‰ç”¨ç¨‹å¼ã€‚

### 2. æ–°çš„ API ç«¯é»

```
POST http://localhost:8080/api/users/vip/validate
```

é€™å€‹ç«¯é»æ¥æ”¶ `UserVipRequest` (Record æ ¼å¼) ä¸¦é€²è¡Œé©—è­‰ã€‚

---

## ğŸ§ª æ¸¬è©¦æ¡ˆä¾‹

### âœ… æ¸¬è©¦ 1ï¼šé©—è­‰æˆåŠŸ - æ™®é€šæœƒå“¡

**Postman è¨­å®šï¼š**
```
Method: POST
URL: http://localhost:8080/api/users/vip/validate
Headers: Content-Type: application/json
Body (raw, JSON):
{
  "userId": 1,
  "name": "å¼µä¸‰",
  "age": 25,
  "vipLevel": 0,
  "discountRate": 0
}
```

**é æœŸçµæœï¼š**
```
Status: 200 OK
Response: é©—è­‰é€šéï¼ä½¿ç”¨è€…: å¼µä¸‰, VIPç­‰ç´š: 0, æŠ˜æ‰£ç‡: 0%
```

**é©—è­‰é€šéåŸå› ï¼š**
- âœ… æ™®é€šæœƒå“¡ï¼ˆvipLevel = 0ï¼‰
- âœ… ç„¡æŠ˜æ‰£ï¼ˆdiscountRate = 0ï¼‰
- âœ… `isValidVipDiscount()` è¿”å› true

---

### âœ… æ¸¬è©¦ 2ï¼šé©—è­‰æˆåŠŸ - éŠ€å¡æœƒå“¡

**Postman è¨­å®šï¼š**
```
Method: POST
URL: http://localhost:8080/api/users/vip/validate
Headers: Content-Type: application/json
Body (raw, JSON):
{
  "userId": 2,
  "name": "æå››",
  "age": 28,
  "vipLevel": 1,
  "discountRate": 8
}
```

**é æœŸçµæœï¼š**
```
Status: 200 OK
Response: é©—è­‰é€šéï¼ä½¿ç”¨è€…: æå››, VIPç­‰ç´š: 1, æŠ˜æ‰£ç‡: 8%
```

**é©—è­‰é€šéåŸå› ï¼š**
- âœ… éŠ€å¡æœƒå“¡ï¼ˆvipLevel = 1ï¼‰
- âœ… æŠ˜æ‰£ç‡ 8% åœ¨å…è¨±ç¯„åœå…§ï¼ˆ5-10%ï¼‰
- âœ… `isValidVipDiscount()` è¿”å› true

---

### âœ… æ¸¬è©¦ 3ï¼šé©—è­‰æˆåŠŸ - ç™½é‡‘å¡æœƒå“¡

**Postman è¨­å®šï¼š**
```json
{
  "userId": 4,
  "name": "è¶™å…­",
  "age": 40,
  "vipLevel": 3,
  "discountRate": 25
}
```

**é æœŸçµæœï¼š**
```
Status: 200 OK
Response: é©—è­‰é€šéï¼ä½¿ç”¨è€…: è¶™å…­, VIPç­‰ç´š: 3, æŠ˜æ‰£ç‡: 25%
```

**é©—è­‰é€šéåŸå› ï¼š**
- âœ… ç™½é‡‘å¡æœƒå“¡ï¼ˆvipLevel = 3ï¼‰
- âœ… å¹´é½¡ 40 æ­²ï¼ˆâ‰¥ 30 æ­²ï¼‰
- âœ… æŠ˜æ‰£ç‡ 25% åœ¨å…è¨±ç¯„åœå…§ï¼ˆ20-30%ï¼‰
- âœ… æ‰€æœ‰ `@AssertTrue` æ–¹æ³•éƒ½è¿”å› true

---

### âŒ æ¸¬è©¦ 4ï¼šé©—è­‰å¤±æ•— - VIP ç­‰ç´šèˆ‡æŠ˜æ‰£ç‡ä¸ç¬¦

**Postman è¨­å®šï¼š**
```json
{
  "userId": 5,
  "name": "å­«ä¸ƒ",
  "age": 25,
  "vipLevel": 0,
  "discountRate": 5
}
```

**é æœŸçµæœï¼š**
```json
{
  "message": "é©—è­‰å¤±æ•—",
  "errors": {
    "validVipDiscount": "VIP ç­‰ç´šèˆ‡æŠ˜æ‰£ç‡ä¸ç¬¦åˆè¦å‰‡"
  }
}
```

**é©—è­‰å¤±æ•—åŸå› ï¼š**
- âŒ æ™®é€šæœƒå“¡ï¼ˆvipLevel = 0ï¼‰æ‡‰è©²ç„¡æŠ˜æ‰£
- âŒ ä½† discountRate = 5
- âŒ `isValidVipDiscount()` è¿”å› false

---

### âŒ æ¸¬è©¦ 5ï¼šé©—è­‰å¤±æ•— - éŠ€å¡æŠ˜æ‰£ç‡è¶…å‡ºç¯„åœ

**Postman è¨­å®šï¼š**
```json
{
  "userId": 6,
  "name": "å‘¨å…«",
  "age": 30,
  "vipLevel": 1,
  "discountRate": 15
}
```

**é æœŸçµæœï¼š**
```json
{
  "message": "é©—è­‰å¤±æ•—",
  "errors": {
    "validVipDiscount": "VIP ç­‰ç´šèˆ‡æŠ˜æ‰£ç‡ä¸ç¬¦åˆè¦å‰‡"
  }
}
```

**é©—è­‰å¤±æ•—åŸå› ï¼š**
- âŒ éŠ€å¡æœƒå“¡ï¼ˆvipLevel = 1ï¼‰æŠ˜æ‰£ç‡æ‡‰ç‚º 5-10%
- âŒ ä½† discountRate = 15ï¼ˆè¶…å‡ºç¯„åœï¼‰
- âŒ `isValidVipDiscount()` è¿”å› false

---

### âŒ æ¸¬è©¦ 6ï¼šé©—è­‰å¤±æ•— - ç™½é‡‘å¡å¹´é½¡ä¸è¶³

**Postman è¨­å®šï¼š**
```json
{
  "userId": 7,
  "name": "å³ä¹",
  "age": 25,
  "vipLevel": 3,
  "discountRate": 25
}
```

**é æœŸçµæœï¼š**
```json
{
  "message": "é©—è­‰å¤±æ•—",
  "errors": {
    "validPlatinumAge": "ç™½é‡‘å¡åƒ…é™ 30 æ­²ä»¥ä¸Šæœƒå“¡ç”³è«‹"
  }
}
```

**é©—è­‰å¤±æ•—åŸå› ï¼š**
- âŒ ç™½é‡‘å¡æœƒå“¡ï¼ˆvipLevel = 3ï¼‰è¦æ±‚å¹´æ»¿ 30 æ­²
- âŒ ä½† age = 25ï¼ˆæœªæ»¿ 30 æ­²ï¼‰
- âŒ `isValidPlatinumAge()` è¿”å› false

---

### âŒ æ¸¬è©¦ 7ï¼šé©—è­‰å¤±æ•— - å¹´é½¡æœªæ»¿ 18 æ­²

**Postman è¨­å®šï¼š**
```json
{
  "userId": 8,
  "name": "é„­å",
  "age": 16,
  "vipLevel": 0,
  "discountRate": 0
}
```

**é æœŸçµæœï¼š**
```json
{
  "message": "é©—è­‰å¤±æ•—",
  "errors": {
    "age": "å¹´é½¡å¿…é ˆå¤§æ–¼ç­‰æ–¼ 18 æ­²"
  }
}
```

**é©—è­‰å¤±æ•—åŸå› ï¼š**
- âŒ `@Min(value = 18)` é©—è­‰å¤±æ•—
- æ³¨æ„ï¼šé€™æ˜¯åŸºæœ¬é©—è­‰ï¼Œæœƒåœ¨ `@AssertTrue` ä¹‹å‰åŸ·è¡Œ

---

### âŒ æ¸¬è©¦ 8ï¼šé©—è­‰å¤±æ•— - å¤šå€‹éŒ¯èª¤åŒæ™‚ç™¼ç”Ÿ

**Postman è¨­å®šï¼š**
```json
{
  "userId": 11,
  "name": "æ¸¬",
  "age": 16,
  "vipLevel": 3,
  "discountRate": 25
}
```

**é æœŸçµæœï¼š**
```json
{
  "message": "é©—è­‰å¤±æ•—",
  "errors": {
    "name": "å§“åé•·åº¦å¿…é ˆåœ¨ 2-50 å­—å…ƒä¹‹é–“",
    "age": "å¹´é½¡å¿…é ˆå¤§æ–¼ç­‰æ–¼ 18 æ­²",
    "validPlatinumAge": "ç™½é‡‘å¡åƒ…é™ 30 æ­²ä»¥ä¸Šæœƒå“¡ç”³è«‹"
  }
}
```

**é©—è­‰å¤±æ•—åŸå› ï¼š**
- âŒ å§“ååªæœ‰ 1 å€‹å­—ï¼ˆé•å `@Size(min = 2)`ï¼‰
- âŒ å¹´é½¡ 16 æ­²ï¼ˆé•å `@Min(18)`ï¼‰
- âŒ ç™½é‡‘å¡ä½†å¹´é½¡ä¸è¶³ï¼ˆé•å `isValidPlatinumAge()`ï¼‰

---

## ğŸ“Š é©—è­‰åŸ·è¡Œé †åº

Bean Validation æœƒæŒ‰ç…§ä»¥ä¸‹é †åºåŸ·è¡Œï¼š

```
1. åŸºæœ¬ç´„æŸé©—è­‰ï¼ˆ@NotNull, @NotBlank, @Size, @Min, @Max, @Emailï¼‰
   â†“
2. å¦‚æœåŸºæœ¬é©—è­‰é€šéï¼ŒåŸ·è¡Œ @AssertTrue æ–¹æ³•
   â†“
3. æ‰€æœ‰é©—è­‰éƒ½é€šéï¼Œæ‰æœƒåŸ·è¡Œ Controller çš„æ¥­å‹™é‚è¼¯
```

**é‡è¦ï¼š** å¦‚æœåŸºæœ¬é©—è­‰å¤±æ•—ï¼Œ`@AssertTrue` æ–¹æ³•ä¸æœƒåŸ·è¡Œã€‚

---

## ğŸ” è§€å¯Ÿé‡é»

### 1. Record çš„ @AssertTrue æ–¹æ³•

æ‰“é–‹ `UserVipRequest.java`ï¼Œè§€å¯Ÿä¸‰å€‹é©—è­‰æ–¹æ³•ï¼š

```java
@AssertTrue(message = "VIP ç­‰ç´šèˆ‡æŠ˜æ‰£ç‡ä¸ç¬¦åˆè¦å‰‡")
public boolean isValidVipDiscount() {
    if (vipLevel == null || discountRate == null) {
        return true;
    }

    return switch (vipLevel) {
        case 0 -> discountRate == 0;      // æ™®é€šæœƒå“¡ç„¡æŠ˜æ‰£
        case 1 -> discountRate >= 5 && discountRate <= 10;  // éŠ€å¡ 5-10%
        case 2 -> discountRate >= 10 && discountRate <= 20; // é‡‘å¡ 10-20%
        case 3 -> discountRate >= 20 && discountRate <= 30; // ç™½é‡‘å¡ 20-30%
        default -> false;
    };
}
```

### 2. IntelliJ Console æ—¥èªŒ

åŸ·è¡Œæ¸¬è©¦æ™‚ï¼Œè§€å¯Ÿ Console çš„æ—¥èªŒè¼¸å‡ºï¼š

**é©—è­‰æˆåŠŸæ™‚ï¼š**
```
2025-11-27 18:00:00.123 [http-nio-8080-exec-1] DEBUG o.s.w.s.m.m.a.RequestMappingHandlerMapping - Mapped to ...
```

**é©—è­‰å¤±æ•—æ™‚ï¼š**
```
2025-11-27 18:00:00.456 [http-nio-8080-exec-2] WARN  c.e.v.e.h.GlobalExceptionHandler - Controller å±¤é©—è­‰å¤±æ•—: ...
```

### 3. Compact Constructor

`UserVipRequest` ä½¿ç”¨äº† Compact Constructor è¨­å®šé è¨­å€¼ï¼š

```java
public UserVipRequest {
    if (vipLevel == null) {
        vipLevel = 0;  // é è¨­ç‚ºæ™®é€šæœƒå“¡
    }
    if (discountRate == null) {
        discountRate = 0;  // é è¨­ç„¡æŠ˜æ‰£
    }
}
```

**æ¸¬è©¦ï¼š** è©¦è©¦çœ‹ä¸æä¾› `vipLevel` å’Œ `discountRate`ï¼Œçœ‹çœ‹æ˜¯å¦æœƒè‡ªå‹•è¨­ç‚º 0ã€‚

---

## ğŸ“ æ¸¬è©¦æª¢æŸ¥æ¸…å–®

åŸ·è¡Œä»¥ä¸‹æ¸¬è©¦ä¸¦æ‰“å‹¾ï¼š

- [ ] æ¸¬è©¦ 1ï¼šæ™®é€šæœƒå“¡ï¼ˆé©—è­‰æˆåŠŸï¼‰
- [ ] æ¸¬è©¦ 2ï¼šéŠ€å¡æœƒå“¡ï¼ˆé©—è­‰æˆåŠŸï¼‰
- [ ] æ¸¬è©¦ 3ï¼šç™½é‡‘å¡æœƒå“¡ï¼ˆé©—è­‰æˆåŠŸï¼‰
- [ ] æ¸¬è©¦ 4ï¼šVIP ç­‰ç´šèˆ‡æŠ˜æ‰£ç‡ä¸ç¬¦ï¼ˆé©—è­‰å¤±æ•—ï¼‰
- [ ] æ¸¬è©¦ 5ï¼šéŠ€å¡æŠ˜æ‰£ç‡è¶…å‡ºç¯„åœï¼ˆé©—è­‰å¤±æ•—ï¼‰
- [ ] æ¸¬è©¦ 6ï¼šç™½é‡‘å¡å¹´é½¡ä¸è¶³ï¼ˆé©—è­‰å¤±æ•—ï¼‰
- [ ] æ¸¬è©¦ 7ï¼šå¹´é½¡æœªæ»¿ 18 æ­²ï¼ˆé©—è­‰å¤±æ•—ï¼‰
- [ ] æ¸¬è©¦ 8ï¼šå¤šå€‹éŒ¯èª¤åŒæ™‚ç™¼ç”Ÿï¼ˆé©—è­‰å¤±æ•—ï¼‰

---

## ğŸ“ å­¸ç¿’è¦é»

å®Œæˆæ¸¬è©¦å¾Œï¼Œä½ æ‡‰è©²ç†è§£ï¼š

1. âœ… **Record å®Œå…¨æ”¯æ´ `@AssertTrue`**
   - èªæ³•èˆ‡ Class ç›¸åŒ
   - å¯ä»¥è¨ªå•æ‰€æœ‰æ¬„ä½é€²è¡Œè¤‡é›œé©—è­‰

2. âœ… **é©—è­‰åŸ·è¡Œé †åº**
   - å…ˆåŸ·è¡ŒåŸºæœ¬é©—è­‰ï¼ˆ@NotNull, @Min ç­‰ï¼‰
   - å†åŸ·è¡Œ @AssertTrue æ–¹æ³•
   - ä»»ä½•ä¸€æ­¥å¤±æ•—éƒ½æœƒä¸­æ–·ä¸¦è¿”å›éŒ¯èª¤

3. âœ… **Record çš„å„ªå‹¢**
   - èªæ³•æ›´ç°¡æ½”ï¼ˆä¸éœ€è¦ Lombokï¼‰
   - ä¸å¯è®Šæ€§ï¼ˆimmutableï¼‰æ›´å®‰å…¨
   - å¯ä»¥ä½¿ç”¨ Compact Constructor è¨­å®šé è¨­å€¼

4. âœ… **è·¨æ¬„ä½é©—è­‰**
   - `@AssertTrue` å¯ä»¥åŒæ™‚æª¢æŸ¥å¤šå€‹æ¬„ä½
   - é©åˆè¤‡é›œçš„æ¥­å‹™è¦å‰‡é©—è­‰
   - é©—è­‰é‚è¼¯é›†ä¸­åœ¨ DTOï¼ŒService å±¤æ›´ç°¡æ½”

---

## ğŸ’¡ é€²éšç·´ç¿’

è©¦è‘—ä¿®æ”¹ `UserVipRequest.java`ï¼Œæ–°å¢ä¸€å€‹é©—è­‰è¦å‰‡ï¼š

**æ¥­å‹™éœ€æ±‚ï¼š** é‡‘å¡å’Œç™½é‡‘å¡æœƒå“¡åç¨±å¿…é ˆè‡³å°‘ 3 å€‹å­—å…ƒ

```java
@AssertTrue(message = "é‡‘å¡å’Œç™½é‡‘å¡æœƒå“¡åç¨±å¿…é ˆè‡³å°‘ 3 å€‹å­—å…ƒ")
public boolean isValidPremiumMemberName() {
    if (vipLevel == null || name == null) {
        return true;
    }

    // é‡‘å¡ï¼ˆ2ï¼‰å’Œç™½é‡‘å¡ï¼ˆ3ï¼‰åç¨±è‡³å°‘ 3 å€‹å­—å…ƒ
    if (vipLevel >= 2) {
        return name.length() >= 3;
    }

    return true;
}
```

ç„¶å¾Œæ¸¬è©¦çœ‹çœ‹æ˜¯å¦ç”Ÿæ•ˆï¼

---

**ç¥æ¸¬è©¦é †åˆ©ï¼** ğŸš€
